# 学会这八种架构模式，系统架构才能游刃有余

本专栏是关于架构的内容，前面介绍了很多关于底层技术的内容。太底层的内容比较烧脑，我们今天介绍一些High Level（高层次）的内容。今天我们介绍一下目前业界常见的**架构模式及案例**。有人可能会说，设计模式我听说过，架构模式是什么鬼？架构模式是相对于软件架构来说的，**软件架构是软件设计的范畴，它确定了软件系统的骨架**。架构模式是对常见软件系统架构的总结和抽象，架构模式与软件设计模式非常像，但通常在更高的层面上，软件设计模式通常在系统模块级别或者子系统级别，而软件架构模式则通常在整个系统级别（并非绝对）。

这些架构模式通常是在成功软件项目的基础上总结出来的。学习这些模式可以方便我们日后软件设计工作。每种架构模式都用于解决某些问题，而每种模式又有其优点和局限性。**在软件开发中其实完全创新的地方很少，风险也会很大，站在巨人肩膀上才是王道。**

分层模式
====

分层模式应该是使用最多的模式之一。我们在前面介绍的TCP/IP协议其实就是分层模式，而内核代码在实现的时候也是分层实现的。分层模式将业务分为若干层，层与层之间相对独立。这种设计的核心理念其实还是设计模式中对软件高内聚，低耦合的要求。

![](https://p3.toutiaoimg.com/large/pgc-image/a8f8f0b98dad4562bf9946d2dab5151a)

图1 TCP/IP协议栈

在分层架构模式中，**每一层在具体代码实现层面完全独立，而高层的功能实现依赖于底层**。以TCP/IP协议为例，在网络层的IP协议只负责数据报的传输，它尽可能的将数据包从一个节点传输到另外一个节点，但中间环节的故障都有可能将数据搞丢。IP协议并不保证数据可靠的被接收。

TCP协议在IP协议之上，它实现了数据报的可靠和可控传输。TCP通过IP层将数据传输出去，同时**在数据中增加序列号、确认标识等内容**，通过这些附加信息保证数据可以被有序、可靠的接收。

**关于分层架构的另外一个典型的例子是Web服务程序**。Web服务程序通常分为表示层、业务逻辑层、持久化层和存储层，具体如图2所示。

![](https://p3.toutiaoimg.com/large/pgc-image/829ec2868cd446059d3d0eabd5657897)

图2 Web服务分层架构

以公有云为例，其中表示层仅仅负责功能的呈现，比如虚拟机或者卷列表、创建虚拟机和卷等功能。而业务逻辑层则负责具体的动作，它提供给表现层具体的接口（目前用的比较多的是RESTful）。比如创建虚拟机的具体操作，在业务逻辑层具体实现。持久化层则构建了编程语言数据结构与数据库数据之间的关联关系（ORM），将程序层面的数据操作转换为数据库的SQL操作，实现数据持久化和查询等。数据库层就是数据库集群系统，实现高可靠的数据库服务。

**通过上述事例可以看出，各层相对独立，底层通过接口（API）的方式为上层提供功能支持。**

客户端-服务器模式
=========

客户端-服务器模式大家应该都非常熟悉了，在该模式中软件分别位于一个服务器和多个客户端上。在该架构模式中通常服务器上的软件是功能核心，客户端上的软件其辅助作用，两者配合完成整个业务逻辑。

![](https://p3.toutiaoimg.com/large/pgc-image/9087745e33214669ac6116c42bf45713)

图3 客户端-服务端架构

其中我们在前面介绍的网络协议中，TCP协议和HTTP协议其实都是客户端-服务器模式。服务端等待客户端的连接，并且由客户端驱动服务端的业务逻辑。

而在软件系统中客户端-服务器模式的例子就更多了。比如在存储领域的NAS存储和SAN存储都是客户端-服务器模式。另外现在比较热门的缓存系统其实也是客户端-服务端模式，比如Redis和Memcached等。

主从设备架构模式
========

**主从架构模式在数据存储领域应用比较多**，当然其它领域也有很多应用。主从模式由两部分组成，也就是主设备和从设备。通常情况下主设备有一个，而从设备可以有一个或者多个，也就是一主多从。

![](https://p3.toutiaoimg.com/large/pgc-image/501769526161418b8c0a09aca770c289)

图4 主从架构

**最长见的主从架构的例子恐怕就是MySQL数据库吧**。通常大家为了保证数据库业务的可用性都采用主从架构，这样当主库出现故障的时候，通过浮动IP可以相对平滑的切换到从库，从而保证业务的可用性。

**另外一个比较常见的就是就是Nginx服务器**。Nginx通常作为反向代理，但如果只有一个Nginx服务器将会形成单点，因此需要通过集群管理软件（例如Heartbeat或者Keepalived等）组建一个主备集群。构建成主备集群后，就可以通过主服务器对外提供服务，而主服务器故障的情况下就可以通过备服务器对外提供服务，从而保证整体业务的可用性。

**主备架构模式除了在系统级之外，还可以在系统内部**。比如Ceph 存储的多副本服务其实也可以理解成为一个主备架构模式。Ceph数据访问通常是通过主副本进行，但在主副本所在硬件故障的情况下，就可以通过从副本继续对外提供服务。

因此，我们要活学活用，学的是模式，具体应用场景需要大家灵活把握。

管道-过滤器模式
========

使用Linux操作比较多的同学应该对Linux的Shell命令比较熟悉。其实Linux操作系统的Shell就使用了管道-过滤器模式。比如下面一条命令用于**列出当前用户使用最多的5个命令。**

> history | awk '{print $2}' | sort | uniq -u | sort -rn | head -5

上面命令是由6个命令组成了，每个命令可以认为是一个过滤器，过滤器之间通过管道连接。前面一个过滤器的输出作为后面一个过滤器的输入。

**这个架构模式在OpenStack中用的比较多，比如Cinder-API的架构**。在Cinder-API服务中可以配置很多处理插件，这些插件在请求入口与业务逻辑之间。**也就是请求在达到真正的业务逻辑之前会经过这些插件的预处理**。插件可以根据需要实现功能，比如权限认证、请求体大小限制和审计等等。经过层层过滤，只有符合这些插件要求的请求才能最终到达业务处理逻辑。

![](https://p3.toutiaoimg.com/large/pgc-image/786245d0a04d4fa6bb090da55879e8d2)

图5 Cinder API架构

代理模式
====

代理模式模式用于构造具有解耦组件的分布式系统。这些组件可以通过远程服务调用或者RESTFul等方式彼此交互。

![](https://p3.toutiaoimg.com/large/pgc-image/94fe591511cf4ad09ab77c3924dd4eee)

服务器将其功能(服务和特征)发布给代理。客户端从代理请求服务，然后代理将客户端重定向到其注册中心的适当服务。

最简单的应用可能就是通过Nginx做反向代理，或者LVS做负载均衡的例子。后端业务服务器注册到Nginx，然后当有客户端请求的时候，Nginx服务器根据负载策略将请求转发给后端的业务服务器进行处理。

代理架构模式可以很简单，也可以很复杂。比如上述概念中的客户端、代理服务和业务服务的概念需要灵活掌握。以OpenStack中的Cinder服务为例，可以将Cinder-API理解为客户端，而Schedule服务理解为代理服务，Cinder-Volume理解为业务服务。以创建云盘为例，Cinder-API接收到命令后转发给消息队列，Schedule服务对请求进行综合判断后将请求发送给Cinder-Volume服务进行处理。
