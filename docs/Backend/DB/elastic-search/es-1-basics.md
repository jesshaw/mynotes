# ElasticSearch基础知识

## 定义

Elasticsearch 是一个基于 Apache Lucene 构建的Restful的功能强大且灵活的搜索和分析引擎，广泛应用于日志分析、网站搜索、数据分析和业务智能等领域，适用于需要快速搜索和分析海量数据的场景。具有以下特征：

1. **分布式架构**
Elasticsearch 采用分布式架构，支持水平扩展。它可以在多个节点上存储和处理数据，确保高可用性和容错性。当需要处理大量数据时，可以通过增加更多的节点来提高性能。

2. **全文搜索**
Elasticsearch 专注于提供强大的全文搜索功能。它支持复杂的查询语法，可以对文本进行高效的索引和搜索，支持模糊搜索、分词搜索、短语搜索等多种搜索方式。

3. **实时数据处理**
Elasticsearch 具备近实时（Near Real-Time, NRT）的特性，能够快速处理和搜索刚刚写入的数据。这使得用户能够及时获取最新的数据结果，非常适合实时分析和监控应用。

4. **RESTful API**
Elasticsearch 提供了丰富的 RESTful API，使得用户可以通过标准的 HTTP 方法（如 GET、POST、PUT、DELETE）与其交互。用户可以方便地进行数据的索引、搜索和管理。

5. **灵活的数据模型**
Elasticsearch 采用基于文档的数据模型，数据以 JSON 格式存储为文档。用户可以根据需求灵活定义数据结构，支持多种数据类型。

6. **强大的聚合功能**
Elasticsearch 提供了强大的聚合功能，可以对数据进行统计、分析和分组，以获取有价值的信息和见解。聚合可以用于生成实时报告和仪表板。

7. **生态系统**
Elasticsearch 是 Elastic Stack 的核心组成部分，通常与 Logstash（用于数据收集和处理）、Kibana（用于数据可视化）和 Beats（用于轻量级数据传输）一起使用，形成一个完整的数据处理和分析解决方案。

8. **可扩展性和插件支持**
Elasticsearch 支持多种插件，可以扩展其功能。用户可以根据需求自定义搜索、分析和监控等功能。

### 基本概念

- **（1）Cluster 集群：** es独一无二的标识 ------ cluster.name。
- **（2）Node  节点：** 物理概念，一台机器就是一个节点，Cluster由Node组成。
- **（3）index 索引：** 索引类似于mysql 中的数据库，Elasticesearch 中的索引是存在数据的地方，包含了一堆有相似结构的文档数据。
  - 索引名规范：
    - 必须小写
    - 不能以_、-、+开头
    - 不能包含空格、\、*、\、<、>、|、,、/、？
- **（4）type 类型：** 类型是用来定义数据结构，可以认为是 mysql 中的一张表，- type 是 index 中的一个逻辑数据分类。
  - 版本差异：
    - 5.x：一个Index可以有多个Type
    - 6.x：一个Index只能有1个Type
    - 7.x：移除了Type的概念
- **（5）document 文档：** 类似于 MySQL 中的一行，不同之处在于 ES 中的每个文档可以有不同的字段，但是对于通用字段应该具有相同的数据类型，文档是es中的最小数据单元，可以认为一个文档就是一条记录。
- **（6）Field 字段：** Field是Elasticsearch的最小单位，一个document里面有多个field。
- **（7）shard 分片：** 单台机器无法存储大量数据，es可以将一个索引中的数据切分为多个shard，分布在多台服务器上存储。有了shard就可以横向扩展，存储更多数据，让搜索和分析等操作分布到多台服务器上去执行，提升吞吐量和性能。
- **（8）replica 副本：** 任何一个服务器随时可能故障或宕机，此时 shard 可能会丢失，因此可以为每个 shard 创建多个 replica 副本。replica可以在shard故障时提供备用服务，保证数据不丢失，多个replica还可以提升搜索操作的吞吐量和性能。primary shard（建立索引时一次设置，不能修改，默认5个），replica shard（随时修改数量，默认1个），默认每个索引10个 shard，5个primary shard，5个replica shard，最小的高可用配置，是2台服务器。
  - replica好处：
    - 提高容错
    - 提升查询效率

### 3、核心数据类型

- **（1）字符串**
  - text：会分词，需要搜索的文本字段
  - keyword：不会分词，需要精准匹配的字段
- **（2）数字类型**
  - byte/short/integer/long/float/double/half_float/scaled_float
  - 日期类型 - date
  - 布尔类型 - boolean
  - 二进制型 - binary
  - 范围类型 - range
- **（3）复杂数据类型**
  - 数据类型 - array
  - 对象类型 - object
  - 嵌套类型 - nested
- **（4）地理数据类型**
  - 地理点类型 - geo point
  - 地理形状类型 - geo_shape
- **（5）专门数据类型**
  - IP类型
  - 计数数据类型 - token-count5

### 4、正排索引 VS 倒排索引

- **（1）正排索引：** 从doc id到内容/单词的关联关系
- **（2）倒排索引：** 从内容/单词到(doc, freq)的关联关系
- 在搜索引擎中，每个文档都有一个对应的文档 ID，文档内容被表示为一系列关键词的集合。例如，某个文档经过分词，提取了 20 个关键词，每个关键词都会记录它在文档中出现的次数和出现位置。那么，倒排索引就是 关键词到文档 ID 的映射，每个关键词都对应着一系列的文件，这些文件中都出现了该关键词。有了倒排索引，搜索引擎可以很方便地响应用户的查询。
- 要注意倒排索引的两个重要细节：
  - 倒排索引中的所有词项对应一个或多个文档
  - 倒排索引中的词项 根据字典顺序升序排列

### 5、DocValues

- 倒排索引也是有缺陷的，假如我们需要对数据做一些聚合操作，比如排序/分组时，lucene内部会遍历提取所有出现在文档集合的排序字段，然后再次构建一个最终的排好序的文档集合list，这个步骤的过程全部维持在内存中操作，而且如果排序数据量巨大的话，非常容易就造成solr内存溢出和性能缓慢。
- DocValues 就是 es 在构建倒排索引的同时，构建了正排索引，保存了docId到各个字段值的映射，可以看作是以文档为维度，从而实现根据指定字段进行排序和聚合的功能。
- 另外doc Values 保存在操作系统的磁盘中，当docValues大于节点的可用内存，ES可以从操作系统页缓存中加载或弹出，从而避免发生内存溢出的异常，docValues远小于节点的可用内存，操作系统自然将所有Doc Values存于内存中（堆外内存），有助于快速访问。

### 6、text VS keyword

- 两个的区别主要分词的区别：keyword 类型是不会分词的，直接根据字符串内容建立倒排索引，keyword类型的字段只能通过精确值搜索到；Text 类型在存入 Elasticsearch 的时候，会先分词，然后根据分词后的内容建立倒排索引。

### 7、什么是停用词分词

- 停用词是指在信息检索中，为节省存储空间和提高搜索效率，在处理自然语言数据（或文本）之前或之后会自动过滤掉某些字或词，这些字或词即被称为Stop Words（停用词）。
- 停顿词可以看成是没有意义的词，比如"的"、"而"，这类词没有必要建立索引。

### 8、query VS filter

- **（1）query：** 查询操作不仅仅会进行查询，还会计算分值，用于确定相关度；
- **（2）filter：** 查询操作仅判断是否满足查询条件，不会计算任何分值，也不会关心返回的排序问题，同时，filter 查询的结果可以被缓存，提高性能。

### 9、match VS term

- **（1）match：** 模糊匹配查询
- **（2）term：** 完全匹配查询
- term是代表完全匹配，即不进行分词器分析，文档中必须包含整个搜索的词汇
- match和term的区别是,match查询的时候,elasticsearch会根据你给定的字段提供合适的分析器，而term查询不会有分析器分析的过程，match查询相当于模糊匹配,只包含其中一部分关键词就行。
