# ElasticSearch

## Elasticsearch的分布式原理

Elasticsearch 是一个开源的分布式搜索引擎，基于 Apache Lucene 构建。其分布式架构使得它能够处理海量数据，提供快速的全文搜索和分析能力。以下是 Elasticsearch 分布式原理的核心要点：

### 1. **集群（Cluster）**

Elasticsearch 运行在集群模式下，一个集群由多个节点组成。每个节点运行在一个独立的服务器上，集群内的所有节点共享相同的集群名称。集群可以横向扩展，增加节点以提升性能和容量。

- **主节点（Master Node）**：负责管理集群的元数据、节点加入/离开和分片分配等。
- **数据节点（Data Node）**：存储实际数据并处理数据相关的操作，比如搜索和聚合查询。
- **协调节点（Coordinating Node）**：负责分发搜索请求给其他节点，汇总结果后返回给客户端。
- **专用节点**：可以将某些节点配置为专用节点，如主节点、协调节点或数据节点，从而优化集群性能。

### 2. **索引与文档（Index and Document）**

数据在 Elasticsearch 中以文档形式存储，文档是 JSON 格式。多个文档被存储在一个索引中，相当于一个数据库。每个文档都有一个唯一的 `_id` 标识符。

### 3. **分片与副本（Shard and Replica）**

为了支持分布式架构，Elasticsearch 将索引划分为多个**主分片（Primary Shard）**，并为每个主分片创建若干个**副本分片（Replica Shard）**。这些分片被分布在集群的多个节点上，实现数据的水平扩展和冗余。

- **主分片**：用于处理写入请求，每个文档只能存储在一个主分片中。
- **副本分片**：用于冗余备份，提高数据的可用性和故障恢复能力。副本分片还可用于处理读取请求，从而提升读性能。
- **分片路由**：Elasticsearch 使用哈希算法将文档路由到合适的分片。

### 4. **数据分布与路由**

Elasticsearch 通过哈希值对文档的 `_id` 进行哈希计算，决定将文档存储在哪个主分片中。当用户发出请求时，协调节点会将请求路由到合适的主分片或副本分片上执行。

### 5. **搜索请求处理**

搜索请求被发送到集群的任意节点，通常称为**协调节点**。协调节点会将搜索请求分发到所有相关的主分片和副本分片上。每个分片独立执行查询操作，并将部分结果返回给协调节点，最终由协调节点汇总这些结果并返回给客户端。

### 6. **数据一致性**

Elasticsearch 使用**主从复制**来实现数据一致性。数据的写入操作首先发生在主分片上，成功写入后，会同步到副本分片。这样可以保证数据的高可用性和故障恢复能力。如果主分片不可用，副本分片可以自动提升为主分片。

### 7. **高可用性与容错**

- **分片副本**：通过将分片复制到多个节点，Elasticsearch 能在节点故障时自动将请求转发到可用的副本分片。
- **自动恢复**：当节点离线或故障时，Elasticsearch 会自动将分片重新分配到其他可用节点上，确保集群的高可用性。

### 8. **扩展性**

Elasticsearch 能够通过添加节点水平扩展，分片可以自动在新节点上均衡分配，保证数据的分布和负载均衡。此外，副本机制保证了集群在高并发环境下的读取性能。

Elasticsearch 通过分片和副本机制、分布式路由和数据分配等方式，实现了高可用性、横向扩展以及高性能的全文搜索和数据分析。

## Elasticsearch 如何选举主节点（Master Node）

在 Elasticsearch 中，主节点（Master Node）的选举是通过一个称为 Zen Discovery 的机制进行的。这个机制确保在集群中始终有一个主节点负责管理集群的元数据、节点的加入和离开以及分片的分配等操作。以下是主节点选举的详细过程：

### 1. **节点加入集群**

当一个节点启动并加入集群时，它会首先向其他节点发送加入请求。每个节点都可以充当候选主节点（Candidate Master）。

### 2. **投票机制**

每个节点在集群中都有一个选举票数，通常情况下每个节点的票数为1。当选举开始时，所有候选主节点会发送自己的节点ID和版本号给其他节点。

### 3. **选举条件**

选举过程遵循以下条件：

- **节点的状态**：只有状态为“绿色”（所有分片都可用）或“黄色”（主分片可用，副本分片不可用）的节点才有资格成为主节点。
- **主节点投票**：候选主节点会向集群中的其他节点请求投票，节点会根据自身的条件投票给其中一个候选主节点。

### 4. **选举过程**

选举过程如下：

1. **发起投票**：所有候选主节点向其他节点发起投票请求。
2. **收集投票**：每个节点在收到请求后，会投票给它认为最合适的候选主节点。
3. **达成共识**：候选主节点需要获得超过半数的投票才能成为新的主节点。假设集群中有N个节点，那么需要获得至少 \( \text{floor}(N/2) + 1 \) 票才能当选为主节点。

### 5. **主节点选举成功**

当一个候选主节点获得所需的票数后，它会被宣布为新的主节点。新主节点会开始管理集群，包括分配分片、处理节点的加入和离开等。

### 6. **网络分区处理**

在出现网络分区的情况下，Zen Discovery 会遵循“法则”：

- 在网络分区后，集群中只有一半的节点或更少的节点可以保持对主节点的访问。只有能够达成大多数的节点（超过半数）才能选举出一个新的主节点。
- 这意味着如果一个节点无法与大多数其他节点通信，它将无法选举出新的主节点，从而防止出现多个主节点（脑裂现象）。

### 7. **故障恢复**

当原主节点恢复在线时，新的主节点会继续管理集群。在集群稳定后，原主节点会被降级，并根据需要重新加入集群。

### 8. **配置选项**

可以通过配置文件中的 `discovery.zen.minimum_master_nodes` 参数来指定最小主节点数。这有助于防止脑裂，确保选举的稳定性和一致性。

Elasticsearch 的主节点选举机制通过投票和达成共识的方式，确保在集群中始终有一个主节点负责管理。它有效地处理了节点故障和网络分区问题，提高了集群的可用性和一致性。

## Elasticsearch 如何避免脑裂

在 Elasticsearch 中，脑裂（Split Brain）是指在网络分区或节点故障的情况下，集群中出现多个主节点的情况。这会导致数据不一致和系统的不稳定。为了避免脑裂，Elasticsearch 采用了以下几种策略：

### 1. **最小主节点数（minimum_master_nodes）**

为了防止脑裂，Elasticsearch 引入了一个配置参数 `discovery.zen.minimum_master_nodes`。这个参数指定了在进行主节点选举时，至少需要多少个主节点才能选举出新的主节点。

- **设置原则**：如果集群中有 N 个节点，则需要设置为 \( \text{floor}(N/2) + 1 \)。例如：
  - 对于 3 个节点的集群，设置为 2。
  - 对于 5 个节点的集群，设置为 3。

这样，当集群中出现网络分区时，只有超过半数的节点能够选举出新的主节点，从而避免出现两个主节点的情况。

### 2. **节点状态监测**

Elasticsearch 通过心跳机制监测节点的健康状态。每个节点会定期向其他节点发送心跳信号，以确认其可用性。如果节点在一定时间内未收到心跳信号，则认为该节点不可用，并将其从集群中移除。

### 3. **分区容忍性**

在发生网络分区时，Elasticsearch 会确保只有具有多数节点的分区能够继续进行主节点选举。这样，不能与大多数节点通信的分区将不会选举出新的主节点，从而防止脑裂。

### 4. **主节点专用**

可以将某些节点配置为专用的主节点，这样可以减少主节点故障的概率。专用主节点可以专注于管理集群状态，而不参与数据存储和查询操作。

### 5. **优先选举**

在进行主节点选举时，Elasticsearch 会考虑节点的状态和版本。如果一个节点在集群中长时间没有更新（例如，在网络分区后），它将不会被选举为主节点。这可以防止过时的节点成为主节点。

### 6. **安全设置**

确保集群的安全性（如使用防火墙、VPN 等）可以减少网络分区的发生，从而降低脑裂的风险。

### 7. **故障恢复**

当一个主节点故障并恢复时，新的主节点会继续管理集群。如果原主节点恢复并重新加入集群，它将被降级为数据节点或副本分片，确保集群的稳定性。

Elasticsearch 通过设置最小主节点数、节点状态监测、分区容忍性、主节点专用配置和优先选举机制等多种方法，有效地避免脑裂现象，确保集群在出现网络分区或节点故障时仍能保持稳定和一致。
