# 队例

## 为什么要用消息队列

消息队列是一种“先进先出”的数据结构。常用于解耦、异步、削峰（还有经济考量）。

## 各种消息队列产品的比较

| 特性 | Kafka | RabbitMQ | RocketMQ | ActiveMQ |
| ----- | ------- | ------- | ------ | ------ |
| **性能** | 高 | 良好 | 高 | 适中 |
| **数据持久化** | 支持 | 支持 | 支持 | 支持 |
| **多语言支持** | 广泛(Java客户端API,第三方支持) | 广泛(Java、Python、.NET等) | 主要是Java客户端，第三方支持 | 广泛(Java、Python等) |
| **应用场景** | 日志聚合、流处理、事件驱动架构等 | RPC、工作队列、传统消息传递等 | 大规模应用，如金融行业 | J2EE应用 |
| **开发语言** | Scala和Java | Erlang | Java | Java |
| **协议** | 自定义的基于TCP的协议 | 支持AMQP等多种协议 | 专有的协议 | 支持JMS等协议 |
| **时效性** | ms级 | us级 | ms级 | ms级以内 |
| **可用性** | 非常高（分布式架构） | 高（主从架构） | 非常高（分布式架构） | 高（主从架构） |
| **单机吞吐量** | 10万级 | 万级 | 10万级 | 万级 |
| **功能特性** | 支持主要的MQ功能，像一些消息查询．消回溯等功能没有提供，毕竟是为大数据准备的，广泛应用于大数据 | 并发能力很强，性能极好，延时较低，管理界面较丰富 | MQ功能比较完备，扩展性佳 | 成的产品．在很多公司得到应用；有较多的文档；各种协议支持较好 |

## 消息队列的优点和缺点

### 优点

- **解耦**：应用程序间通过消息队列相互独立地通信。
- **异步**：接收者可以异步处理消息。
- **削峰填谷**：在高峰期吸收消息，平滑负载。

### 缺点

- **系统复杂度增加**：引入了额外的组件和服务。
- **管理难度增加**：需要维护和监控消息队列系统。

## 如何保证消息队列的高可用

RabbitMQ镜像集群。RocketMQ双主双从。

## 如何保证消息不丢失

消息丢失原因有以下几种情况：

1. 生产都没有成功发送到MQ。
2. MQ宕机导致内存消息丢失。
3. 消费者获取到消息，但还没真正处理宕机了，但MQ中已删除，消费者重启后不能再消费之前的消息。

要解决以上问题可以给出以下方案。

1. 生产者发送给MQ，须得到MQ确认；
2. MQ收到消息后做持久化；
3. 消费者处理化消息后进行确认，MQ收到确认后删除持久化的消息。

## 如何保证消息不被重复消费？（消费的幂等性？）

重复消费的原因不可避免，网络不可达。消息携带全局唯一ID，消费方接到后先查判定是否重复操作再处理。

## 如何保证消息消费的顺序性

消息的顺序消费是指按照消息发送的顺序进行消费，分为全局消息和局部消息，局部顺序消费更常见。

对于全局顺序消息

- 生产者：MQ：消费都=1：1：1。

对于局部顺序消息：

- 生产者将同一组消息发送到单个队列；
- 多个消费者并行对消息进行消费；
- 队列通过分段锁保证消息消费的顺序性。

[引用](https://www.bilibili.com/video/BV1tK411p71q?from=search&seid=11076650873668614869)